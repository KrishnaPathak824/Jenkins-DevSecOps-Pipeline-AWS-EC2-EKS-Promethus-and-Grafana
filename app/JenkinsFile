@Library('shared-library') _
pipeline {
    agent any

    tools {
    nodejs 'Nodejs'
    }

    environment {
        SONAR_HOME = tool name: 'Sonarqube'
        VERSION_FILE = 'VERSION'
    }

    stages {
        stage('Workspace CleanUp') {
            steps {
                cleanWs()
            }
        }
    
        stage('Cloning the repo') {
            steps {
                script{
                    clone("https://github.com/KrishnaPathak824/Jenkins-DevSecOps-Pipeline-AWS-EC2-EKS-Promethus-and-Grafana.git","main")
                }
            }
        }

        stage('Setup Semver Tool') {
            steps {
                script {
                    // Install semver tool if not available
                    sh '''
                        if ! command -v semver &> /dev/null; then
                            echo "Installing semver tool..."
                            npm install -g semver
                        fi
                    '''
                }
            }
        }

        stage('Trivy Filesystem Scan') {
            steps {
                script{
                    trivy()
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('app/frontend'){
                    script{
                        sh '''
                        npm install -g yarn
                        yarn install --frozen-lockfile
                        '''
                    }
                }
                dir('app/backend1'){
                    script{
                        sh 'yarn install --frozen-lockfile'
                    }
                }
                dir('app/backend2'){
                    script{
                        sh 'yarn install --frozen-lockfile'
                    }
                }
                
            }
        }

        stage('Owasp: Dependency Check') {
            steps {
                script{
                    owaspDependencyCheck()
                }
            }
        }

        stage('SonarQube Code Analysis Scan') {
            steps {
                script{
                    sonarqube("Sonarqube","blog-app","blog-app")
                }
            }
        }

        stage('image-build') {
            parallel{
                stage('Frontend Image Build') {
                    steps {
                        script{
                            dockerBuild('app/frontend','blog-app-frontend')
                        }
                    }
                }
                stage('Backend1 Image Build') {
                    steps {
                        script{
                            dockerBuild('app/backend1','blog-app-backend1')
                        }
                    }
                }
                stage('Backend2 Image Build') {
                    steps {
                        script{
                            dockerBuild('app/backend2','blog-app-backend2')
                        }
                    }
                }
            }
        }

        // stage('Generate Release Version') {
        //     steps {
        //         script {
        //             withCredentials([string(credentialsId: 'github', variable: 'GH_TOKEN')]) {
        //                 sh '''
        //                     export GH_TOKEN=$GH_TOKEN
        //                     npx semantic-release --no-ci --verbose
        //                 '''
        //             }
        //         }
        //     }
        // }

        stage('Get Current Version') {
            steps {
                script {
                    // Read current version from VERSION file or git tag
                    if (fileExists(env.VERSION_FILE)) {
                        env.CURRENT_VERSION = readFile(env.VERSION_FILE).trim()
                    } else {
                        // Get latest git tag or default to 0.0.0
                        env.CURRENT_VERSION = sh(
                            script: 'git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0"',
                            returnStdout: true
                        ).trim()
                    }
                    echo "Current version: ${env.CURRENT_VERSION}"
                }
            }
        }

        stage('Determine Version Bump') {
            steps {
                script {
                    // Determine version bump based on commit message or branch
                    def commitMessage = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                    
                    if (commitMessage =~ /(?i)BREAKING CHANGE|major:/) {
                        env.BUMP_TYPE = 'major'
                    } else if (commitMessage =~ /(?i)feat:|feature:/) {
                        env.BUMP_TYPE = 'minor'
                    } else if (commitMessage =~ /(?i)fix:|bugfix:|patch:/) {
                        env.BUMP_TYPE = 'patch'
                    } else {
                        // Default to patch for regular commits
                        env.BUMP_TYPE = 'patch'
                    }
                    
                    echo "Bump type determined: ${env.BUMP_TYPE}"
                }
            }
        }
        
        stage('Calculate New Version') {
            steps {
                script {
                    // Use semver to bump version
                    env.NEW_VERSION = sh(
                        script: "semver -i ${env.BUMP_TYPE} ${env.CURRENT_VERSION}",
                        returnStdout: true
                    ).trim()
                    
                    // Add pre-release suffix if not on main/master branch
                    if (env.BRANCH_NAME && env.BRANCH_NAME != 'main' && env.BRANCH_NAME != 'master') {
                        def preRelease = env.BRANCH_NAME.replaceAll(/[^a-zA-Z0-9]/, '-')
                        env.NEW_VERSION = sh(
                            script: "semver ${env.NEW_VERSION} -i prerelease --preid ${preRelease}",
                            returnStdout: true
                        ).trim()
                    }
                    
                    echo "New version: ${env.NEW_VERSION}"
                }
            }
        }
        
        stage('Update Version File') {
            steps {
                script {
                    // Write new version to VERSION file
                    writeFile file: env.VERSION_FILE, text: env.NEW_VERSION
                    echo "Updated ${env.VERSION_FILE} with version ${env.NEW_VERSION}"
                }
            }
        }
        
        stage('Tag and Push') {
            steps {
                script {
                    // Create git tag and push
                    sh """
                        git config user.email "jenkins@ci.local"
                        git config user.name "Jenkins CI"
                        git add ${env.VERSION_FILE}
                        git commit -m "Bump version to ${env.NEW_VERSION} [skip ci]" || true
                        git tag -a v${env.NEW_VERSION} -m "Release version ${env.NEW_VERSION}"
                        git push origin v${env.NEW_VERSION}
                        git push origin main
                    """
                }
            }
        }

        // stage('Tag and Release') {
        //     steps {
        //         script {
        //             withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
        //                 sh '''#!/bin/bash
        //                     # Configure git
        //                     git config --global user.email "jenkins@example.com"
        //                     git config --global user.name "Jenkins CI"
                            
        //                     # Get the version generated by semantic-release
        //                    VERSION=$(npx semantic-release --dry-run 2>&1 | grep -oP '(?<=The next release version is )[0-9]+\\.[0-9]+\\.[0-9]+' || echo "0.0.0")
        //                    echo "v${VERSION}" > version.txt
        //                    cat version.txt

        //                     # Set git remote with credentials
        //                     git remote set-url origin https://KrishnaPathak824:${GITHUB_TOKEN}@github.com/KrishnaPathak824/Jenkins-DevSecOps-Pipeline-AWS-EC2-EKS-Promethus-and-Grafana.git

        //                     # Check if new version was created
        //                     if ! git rev-parse "v${VERSION}" >/dev/null 2>&1; then
        //                         echo "Creating tag v${VERSION}"
        //                         git tag -a "v${VERSION}" -m "Release v${VERSION}" || echo "Tag already exists"
        //                         git push origin "v${VERSION}" || echo "Push failed"
        //                     else
        //                         echo "Tag v${VERSION} already exists"
        //                     fi
        //                 '''
        //             }
        //         }
        //     }
        // }

        stage("Push to DockerHub") {
    parallel{
        stage('Frontend Push') {
            steps {
                script{
                    withCredentials([usernamePassword('credentialsId':"docker-cred",passwordVariable:"dockerpass",usernameVariable:"dockeruser")]){
                    sh '''
                    docker login -u $dockeruser -p $dockerpass
                    docker image tag blog-app-frontend $dockeruser/blog-app-frontend:${env.VERSION}
                    docker image tag blog-app-frontend $dockeruser/blog-app-frontend:latest
                    docker push $dockeruser/blog-app-frontend:${env.VERSION}
                    docker push $dockeruser/blog-app-frontend:latest
                    '''
                    }
                }
            }
        }
        stage('Backend1 Push') {
            steps {
                script{
                    withCredentials([usernamePassword('credentialsId':"docker-cred",passwordVariable:"dockerpass",usernameVariable:"dockeruser")]){
                    sh '''
                    docker login -u $dockeruser -p $dockerpass
                    docker image tag blog-app-backend1 $dockeruser/blog-app-backend1:${env.VERSION}
                    docker image tag blog-app-backend1 $dockeruser/blog-app-backend1:latest
                    docker push $dockeruser/blog-app-backend1:${env.VERSION}
                    docker push $dockeruser/blog-app-backend1:latest
                    '''
                    }
                }
            }
        }
        stage('Backend2 Push') {
            steps {
                script{
                    withCredentials([usernamePassword('credentialsId':"docker-cred",passwordVariable:"dockerpass",usernameVariable:"dockeruser")]){
                    sh '''
                    docker login -u $dockeruser -p $dockerpass
                    docker image tag blog-app-backend2 $dockeruser/blog-app-backend2:${env.VERSION}
                    docker image tag blog-app-backend2 $dockeruser/blog-app-backend2:latest
                    docker push $dockeruser/blog-app-backend2:${env.VERSION}
                    docker push $dockeruser/blog-app-backend2:latest
                    '''
                    }
                }
            }
        }
    }
}
    
    
}
}